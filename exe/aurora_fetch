#!/usr/bin/env ruby
# frozen_string_literal: true

require "aurora"
require "ccutrer-serialport"
require "uri"

uri = URI.parse(ARGV[0])

args = case uri.scheme
       when "tcp"
         require "socket"
         [TCPSocket.new(uri.host, uri.port)]
       when "telnet", "rfc2217"
         require "net/telnet/rfc2217"
         [Net::Telnet::RFC2217.new(uri.host,
                                   port: uri.port || 23,
                                   baud: 19_200,
                                   parity: :even)]
       else
         [CCutrer::SerialPort.new(uri.path, baud: 19_200, parity: :even)]
       end

client = ModBus::RTUClient.new(*args)
slave = client.with_slave(1)
abc = Aurora::ABCClient.new(slave)
registers = abc.query_registers(ARGV[1])

puts Aurora.print_registers(registers)
