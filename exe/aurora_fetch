#!/usr/bin/env ruby
# frozen_string_literal: true

require "aurora"
require "ccutrer-serialport"
require "logger"
require "optparse"
require "uri"
require "yaml"

debug_modbus = yaml = false

options = OptionParser.new do |opts|
  opts.banner = "Usage: aurora_fetch /path/to/serial/port REGISTERS [options]"

  opts.on("--debug-modbus", "Print actual protocol bytes") { debug_modbus = true }
  opts.on("-y", "--yaml", "Output raw values as YAML") { yaml = true }
  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit
  end
end

options.parse!

unless ARGV.length == 2
  puts options
  exit 1
end

abc = Aurora::ABCClient.new(ARGV[0])
abc.modbus_slave.logger = Logger.new($stdout)
abc.modbus_slave.logger.level = debug_modbus ? :debug : :warn

registers = abc.query_registers(ARGV[1])

if yaml
  puts YAML.dump(registers)
else
  puts Aurora.print_registers(registers)
end
